<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Taiwan Air Quality Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<style>
  html, body {margin:0; padding:0; height:100%; width:100%; overflow:hidden;}
  #map {width:100%; height:100%;}
  .legend {
    background:white; padding:8px; line-height:16px; color:#555;
    box-shadow: 0 0 10px rgba(0,0,0,0.2); border-radius:5px; font-size:12px;
  }
  .legend span {display:inline-block; width:16px; height:16px; margin-right:4px;}
  .nearest-widget {
    position:absolute;
    top:10px;
    right:10px;
    background:white;
    padding:8px;
    border-radius:5px;
    box-shadow:0 0 10px rgba(0,0,0,0.3);
    z-index:1000;
    font-family:sans-serif;
    font-size:12px;
    line-height:1.3;
    max-width:140px;
    word-wrap:break-word;
  }
  .locate-btn {
    position:absolute;
    top:110px;
    right:10px;
    z-index:1000;
    background:white;
    border:none;
    padding:6px 10px;
    border-radius:5px;
    box-shadow:0 0 8px rgba(0,0,0,0.2);
    cursor:pointer;
    font-family:sans-serif;
    font-size:12px;
  }
  .locate-btn:hover {background:#f0f0f0;}
  /* Make touch-friendly */
  @media (max-width:600px){
    .nearest-widget {font-size:11px; max-width:120px; top:8px; right:8px; padding:6px;}
    .locate-btn {top:100px; right:8px; padding:5px 8px; font-size:11px;}
  }
</style>
</head>
<body>

<div id="map"></div>
<div id="nearestWidget" class="nearest-widget">Locating nearest station...</div>
<button class="locate-btn" onclick="locateMe()">üìç Locate Me</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const map = L.map('map', {zoomControl:true}).setView([23.5,121],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:18 }).addTo(map);

const epaCluster = L.markerClusterGroup();
const lassCluster = L.markerClusterGroup();
let nearestMarker = null;
let allStations = [];

const API_KEY = "d547b92d-ab19-4510-9370-bf467d041fc3";
const EPA_URL = `https://data.epa.gov.tw/api/v2/aqx_p_432?format=JSON&limit=1000&api_key=${API_KEY}`;
const LASS_URL = 'https://pm25.lass-net.org/data/last-all-airbox.json';

function aqiColor(aqi){
  if(isNaN(aqi)) return '#888888';
  if(aqi <= 50) return '#00E400';
  if(aqi <= 100) return '#FFFF00';
  if(aqi <= 150) return '#FF7E00';
  if(aqi <= 200) return '#FF0000';
  if(aqi <= 300) return '#8F3F97';
  return '#7E0023';
}

function addMarker(cluster, lat, lon, popupText, color='#FF0000'){
  const marker = L.circleMarker([lat, lon], {
    radius:6, color: color, fillColor: color, fillOpacity:0.7
  });
  marker.bindPopup(popupText);
  cluster.addLayer(marker);
  return marker;
}

function haversine(lat1, lon1, lat2, lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

function updateNearestWidget(station){
  const widget = document.getElementById('nearestWidget');
  if(!station){
    widget.innerHTML = 'No nearby station found';
  } else {
    widget.innerHTML = `<b>${station.name}</b><br>AQI: ${station.aqi}<br>PM2.5: ${station.pm25} ¬µg/m¬≥`;
  }
}

async function loadData(){
  epaCluster.clearLayers();
  lassCluster.clearLayers();
  allStations = [];

  try{
    const resp = await fetch(EPA_URL);
    const data = await resp.json();
    (data.records || data.result?.records || []).forEach(s=>{
      const lat = parseFloat(s.Latitude || s.latitude);
      const lon = parseFloat(s.Longitude || s.longitude);
      const aqi = parseFloat(s.AQI || s.aqi);
      const pm25 = parseFloat(s["PM2.5"] || s.pm2_5);
      if(!isNaN(lat) && !isNaN(lon)){
        const popup = `${s.SiteName || s.sitename} (${s.County || s.county})<br>AQI: ${aqi}<br>PM2.5: ${pm25}`;
        addMarker(epaCluster, lat, lon, popup, aqiColor(aqi));
        allStations.push({lat, lon, aqi, pm25, name: s.SiteName || s.sitename});
      }
    });
  }catch(e){console.log("EPA load error", e);}

  try{
    const resp = await fetch(LASS_URL);
    const raw = await resp.json();
    const feeds = raw.feeds || raw;
    feeds.forEach(f=>{
      const lat = parseFloat(f.gps_lat || f.lat);
      const lon = parseFloat(f.gps_lon || f.lon);
      const pm25 = parseFloat(f.s_d0 || f.pm25);
      if(!isNaN(lat) && !isNaN(lon)){
        const popup = `${f.device_id || 'AirBox'}<br>PM2.5: ${pm25}`;
        addMarker(lassCluster, lat, lon, popup, aqiColor(pm25));
        allStations.push({lat, lon, aqi: pm25, pm25, name: f.device_id || 'AirBox'});
      }
    });
  }catch(e){console.log("LASS load error", e);}

  if(!map.hasLayer(epaCluster)) map.addLayer(epaCluster);
  if(!map.hasLayer(lassCluster)) map.addLayer(lassCluster);

  highlightNearestStation();
}

function highlightNearestStation(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    let minDist = Infinity;
    let nearest = null;
    allStations.forEach(s=>{
      const d = haversine(latitude, longitude, s.lat, s.lon);
      if(d<minDist){minDist=d; nearest=s;}
    });
    if(nearest){
      if(nearestMarker) map.removeLayer(nearestMarker);
      nearestMarker = L.circleMarker([nearest.lat, nearest.lon], {
        radius:10, color:'#0000FF', fillColor:'#0000FF', fillOpacity:0.9
      }).addTo(map);
      nearestMarker.bindPopup(`<b>Nearest Station</b><br>${nearest.name}<br>AQI: ${nearest.aqi}<br>PM2.5: ${nearest.pm25}`).openPopup();
      map.setView([nearest.lat, nearest.lon], 12);
      updateNearestWidget(nearest);
    } else {
      updateNearestWidget(null);
    }
  });
}

function locateMe(){highlightNearestStation();}

const overlayMaps = {
  "EPA Stations": epaCluster,
  "AirBox Stations": lassCluster
};
L.control.layers(null, overlayMaps, {collapsed:false}).addTo(map);

const legend = L.control({position:'bottomright'});
legend.onAdd = function(map){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = "<b>AQI Levels</b><br>";
  const levels = [
    {color:'#00E400', label:'0-50 Good'},
    {color:'#FFFF00', label:'51-100 Moderate'},
    {color:'#FF7E00', label:'101-150 Unhealthy (S)'},
    {color:'#FF0000', label:'151-200 Unhealthy'},
    {color:'#8F3F97', label:'201-300 Very Unhealthy'},
    {color:'#7E0023', label:'301+ Hazardous'}
  ];
  levels.forEach(l=>{div.innerHTML += `<span style="background:${l.color}"></span>${l.label}<br>`;});
  return div;
};
legend.addTo(map);

loadData();
setInterval(loadData, 900000); // refresh every 15 min
</script>

</body>
</html>

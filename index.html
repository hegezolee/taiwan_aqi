<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taiwan Air Quality Map - AirBox Only</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<style>
  html, body { margin:0; padding:0; height:100%; width:100%; }
  #map { width:100%; height:100%; }
  .legend { background:white; padding:8px; line-height:16px; color:#555; box-shadow:0 0 10px rgba(0,0,0,0.2); border-radius:5px; font-size:12px; }
  .legend span { display:inline-block; width:16px; height:16px; margin-right:4px; }
</style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
const map = L.map('map').setView([23.5,121], 7);

// OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:18 }).addTo(map);

const airboxCluster = L.markerClusterGroup();

// AirBox JSON URL
const LASS_URL = "https://pm25.lass-net.org/data/last-all-airbox.json";

// Utility to color based on PM2.5
function pmColor(pm25){
  if(pm25<=15) return '#00E400';
  if(pm25<=35) return '#FFFF00';
  if(pm25<=54) return '#FF7E00';
  if(pm25<=150) return '#FF0000';
  if(pm25<=250) return '#8F3F97';
  return '#7E0023';
}

function addMarker(cluster, lat, lon, popupText, color='#FF0000'){
  const marker = L.circleMarker([lat, lon], { radius:6, color, fillColor: color, fillOpacity:0.7 });
  marker.bindPopup(popupText);
  cluster.addLayer(marker);
}

async function loadAirBox(){
  airboxCluster.clearLayers();

  try{
    const resp = await fetch(LASS_URL);
    const data = await resp.json();
    const feedsObj = data.feeds || {};
    const feeds = Object.values(feedsObj); // convert object to array

    feeds.forEach(f=>{
      const lat = parseFloat(f.gps_lat || f.lat);
      const lon = parseFloat(f.gps_lon || f.lon);
      const pm25 = parseFloat(f.s_d0 || f.pm25);
      if(!isNaN(lat) && !isNaN(lon)){
        const popup = `<b>${f.device_id || 'AirBox'}</b><br>PM2.5: ${pm25} µg/m³`;
        addMarker(airboxCluster, lat, lon, popup, pmColor(pm25));
      }
    });

    map.addLayer(airboxCluster);

  } catch(e){
    console.error("Error fetching AirBox data:", e);
  }
}

// Initial load
loadAirBox();
// Refresh every 15 min
setInterval(loadAirBox, 15*60*1000);

// Legend
const legend = L.control({position:'bottomright'});
legend.onAdd = function(map){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = "<b>PM2.5 Levels</b><br>";
  const levels = [
    {color:'#00E400', label:'0-15 Good'},
    {color:'#FFFF00', label:'16-35 Moderate'},
    {color:'#FF7E00', label:'36-54 Unhealthy (S)'},
    {color:'#FF0000', label:'55-150 Unhealthy'},
    {color:'#8F3F97', label:'151-250 Very Unhealthy'},
    {color:'#7E0023', label:'251+ Hazardous'}
  ];
  levels.forEach(l=>{div.innerHTML += `<span style="background:${l.color}"></span>${l.label}<br>`;});
  return div;
};
legend.addTo(map);

</script>

</body>
</html>
